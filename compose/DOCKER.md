# Using Magento inside Docker

### Assumptions
~/.ssh/config contains a named ssh connection to a site

```
Host production
    hostname {{REMOTE_DOMAIN}}
    user magento
```

## Initializing the instance

This project has a `docker` folder with most of the configuration in. Before starting we need to check the
[./docker/config.env](./docker/config.env) to make sure the details are set correctly for the client.

This involves checking the `LOCAL_DOMAINS`, `REMOTE_DOMAINS` and `SSH_HOST`. `LOCAL_DOMAINS` and `REMOTE_DOMAINS` should
have the same number of domains (if more than one they should be comma space separated eg. "domain.one, domain.two").
These domains are used for db replacement and the first `LOCAL_DOMAINS` found will be the primary domain Docker uses.

We also need to make sure the instance we are downloading imagery from is turned on, so we can access it via ssh.

In the project root directory run `bin/setup` to initialise the project and start docker. You will be put through an
interactive setup script which explains each step.

The imagery synchronise step takes time on the first run but subsequent runs will be quicker as rsync checks image
differences.

At the end you will be given the URL to access the site from.

For WordPress to work correctly the SSL will need to be generated run `bin/setup-ssl {{LOCAL_DOMAIN}}`, the containers 
will refresh and the SSL will work properly.

If you are doing frontend asset compilation (less, js) etc. Run `bin/setup-frontend` to run the required scripts to
setup compilation in the container. Once completed you can run `bin/grunt watch` and the primary theme will be generated
as expected on file updates.


## Built in Commands

To ease the usage process for non docker users, a set of scripts have been provided to run certain tasks from the host.
1. `bin/bash` drop a shell into the fpm container
2. `bin/check` check the output of the docker-compose file with env passed
3. `bin/cleanup` remove all containers associated with the project
4. `bin/cli` pass a command to the fpm container eg. `bin/cli ls -alh` to see files in the default directory of the fpm container
5. `bin/composer` access the composer binary in the fpm container
6. `bin/grunt` access grunt binary in the fpm container
7. `bin/import-db` import downloaded databases into docker instance
8. `bin/local-db-download` download the latest databases from the remote server
9. `bin/local-imagery-import` download imagery from the remote server
10. `bin/logs` view the docker-compose logs generated by the containers
11. `bin/magento` access the magento binary in the fpm container
12. `bin/mysqldump` dump a specific table
13. `bin/n98-magerun` access n98-magerun binary in the fpm container
14. `bin/node` access node binary in the fpm container
15. `bin/npm` access node binary in the fpm container
16. `bin/permissions` set file permissions back to required defaults
17. `bin/restart` restart the docker containers
18. `bin/setup` initial setup for site
19. `bin/setup-frontend` initial frontend setup for site
20. `bin/start` start the docker containers
21. `bin/status` check the instance status
22. `bin/stop` stop the docker containers
23. `bin/wp` access the wp cli binary in the fpm container


## Access containers

FPM: `docker exec --user=www-data -it {{PROJECT_NAME}}_fpm_1 bash`
DB: `docker exec -it {{PROJECT_NAME}}_db_1 bash`
Nginx: `docker exec -it {{PROJECT_NAME}}_web_1 bash`

To view the logs `docker compose logs -f`
If the logs are too big you can shrink them down with the `--tail="10"`

Make sure the Fishpig WordPress theme is copied over to the correct location.


## Cleanup

To remove the data and everything `docker compose down -v`


## Common tasks

**Installing a module with composer**

Run `bin/composer require --dev magento/magento-coding-standard`


## Troubleshooting

**Site refuses to load the frontend with a 500 error
Make sure the Fishpig theme is in the wp-content/themes directory
`bin/n98-magerun fishpig:wordpress:build-theme --install-path=/app/wp`

**GCloud docker credentials can cause issues**
Run `export CLOUDSDK_PYTHON=python2` to make sure the correct Python version is being used.

**Frontend assets not updating on browser refresh**
Make sure you disable magento caching full page cache with `bin/magento cache:disable full_page block_html layout config`